USE [Gymwise1.3]
GO
/****** Object:  StoredProcedure [dbo].[s_pr_get_student_facilities]    Script Date: 19/01/02 6:18:45 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[s_pr_get_student_facilities] (
	@AdmissionNo INT
	,@USER_ID VARCHAR(50) = 'SYSTEM'
	,@NUM_ERROR_CODE INT OUTPUT
	)
AS

begin 
begin try

SET @NUM_ERROR_CODE = 1;




SELECT *,(select sum(INSD_INSTMNT_AMT - (INSD_AMOUNT_PAID + INSD_CNCLD_AMT + INSD_DISCOUNT))  from INSTALLMENTS_DETAILS where 
INSD_FACILITY_ID = STUDENT_FACILITIES.STFL_ID) as Pending ,(select SUM(INSD_AMOUNT_PAID )from INSTALLMENTS_DETAILS where 
INSD_FACILITY_ID = STUDENT_FACILITIES.STFL_ID) as Amount_Paid
FROM STUDENT_FACILITIES
INNER JOIN FEES ON STUDENT_FACILITIES.STFL_FEES_ID = FEES.FEE_ID
INNER JOIN BRANCH_MASTER ON STUDENT_FACILITIES.STFL_BRANCH_ID = BRANCH_MASTER.BRCH_ID
	AND FEES.FEE_BRANCH_ID = BRANCH_MASTER.BRCH_ID
INNER JOIN FEES_PACKAGES ON STUDENT_FACILITIES.STFL_PACKAGE_ID = FEES_PACKAGES.FPKG_ID
WHERE (STUDENT_FACILITIES.STFL_ADMISSION_NO = @AdmissionNo)
	AND (STUDENT_FACILITIES.STFL_IS_MAIN_PACKAGE = 1) and(STFL_STATUS != 'R')

SELECT *,(select sum(INSD_INSTMNT_AMT - (INSD_AMOUNT_PAID + INSD_CNCLD_AMT + INSD_DISCOUNT))  from INSTALLMENTS_DETAILS where 
INSD_FACILITY_ID = STUDENT_FACILITIES.STFL_ID) as Pending ,(select SUM(INSD_AMOUNT_PAID )from INSTALLMENTS_DETAILS where 
INSD_FACILITY_ID = STUDENT_FACILITIES.STFL_ID) as Amount_Paid

FROM STUDENT_FACILITIES
INNER JOIN FEES ON STUDENT_FACILITIES.STFL_FEES_ID = FEES.FEE_ID
INNER JOIN BRANCH_MASTER ON STUDENT_FACILITIES.STFL_BRANCH_ID = BRANCH_MASTER.BRCH_ID
	AND FEES.FEE_BRANCH_ID = BRANCH_MASTER.BRCH_ID
INNER JOIN FEE_STRUCTURE ON STUDENT_FACILITIES.STFL_PACKAGE_ID = FEE_STRUCTURE.FSTR_ID
WHERE (STUDENT_FACILITIES.STFL_ADMISSION_NO = @AdmissionNo) 
	AND (STUDENT_FACILITIES.STFL_IS_MAIN_PACKAGE = 0) and(STFL_STATUS != 'R')


end try
begin catch
exec SP_LogError;
set @NUM_ERROR_CODE=0;

end catch
end




